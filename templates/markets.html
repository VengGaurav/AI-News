<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Markets | {{ symbol }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-gradient shadow sticky-top">
    <div class="container">
        <a class="navbar-brand fw-bold fs-3" href="{{ url_for('home') }}">
            <span class="brand-logo">AI<span class="brand-secondary">news</span><span class="brand-dot"></span></span>
        </a>
        <div class="ms-auto d-flex align-items-center">
            <div class="form-check form-switch ms-3">
                <input class="form-check-input" type="checkbox" role="switch" id="themeSwitch" aria-label="Toggle dark mode">
            </div>
        </div>
    </div>
    
</nav>

<main class="container py-4">
    <div class="row g-4">
        <section class="col-12 col-lg-8">
            <div class="card shadow-sm p-3">
                <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
                    <h2 class="h4 mb-0">{{ symbol }} Market Overview</h2>
                    <div class="ms-auto d-flex gap-2">
                        <input id="symbolInput" class="form-control" placeholder="Symbol e.g. AAPL, TSLA" value="{{ symbol }}" style="max-width: 220px;">
                        <select id="intervalSelect" class="form-select" style="max-width: 140px;">
                            <option value="d" selected>Daily</option>
                            <option value="w">Weekly</option>
                            <option value="m">Monthly</option>
                        </select>
                        <button id="loadBtn" class="btn btn-primary">Load</button>
                    </div>
                </div>
                <canvas id="priceChart" height="120"></canvas>
                <div id="quoteInfo" class="mt-3 small text-muted"></div>
            </div>
        </section>
        <aside class="col-12 col-lg-4">
            <div class="card shadow-sm p-3">
                <h6 class="text-uppercase fw-bold mb-2"><i class="fas fa-newspaper me-2"></i>Market News</h6>
                {% if news %}
                <ul class="list-unstyled m-0">
                    {% for a in news %}
                    <li class="mb-3">
                        <a class="fw-semibold" href="{{ a.url }}" target="_blank">{{ a.title }}</a>
                        <div class="small text-muted">{{ a.source.name }} â€¢ {{ a.publishedAt[:10] if a.publishedAt }}</div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">No market news available.</p>
                {% endif %}
            </div>
        </aside>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
    const ctx = document.getElementById('priceChart').getContext('2d');
    const symbolInput = document.getElementById('symbolInput');
    const intervalSelect = document.getElementById('intervalSelect');
    const loadBtn = document.getElementById('loadBtn');
    const quoteInfo = document.getElementById('quoteInfo');

    let chart;

    function getTheme() {
        return document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
    }
    function getChartColors() {
        const dark = getTheme() === 'dark';
        return {
            border: dark ? '#22c55e' : '#16a34a',
            fill: dark ? 'rgba(34,197,94,0.15)' : 'rgba(22,163,74,0.15)',
            grid: dark ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.06)',
            tick: dark ? '#e6e8eb' : '#0f172a'
        };
    }

    async function fetchJson(url) {
        const res = await fetch(url);
        if (!res.ok) throw new Error('Network error');
        return res.json();
    }

    async function load() {
        const symbol = symbolInput.value || '{{ symbol }}';
        const interval = intervalSelect.value;
        const data = await fetchJson(`/api/markets/history?symbol=${encodeURIComponent(symbol)}&interval=${interval}`);
        let quote = null;
        try {
            quote = await fetchJson(`/api/markets/quote?symbol=${encodeURIComponent(symbol)}`);
        } catch (e) {
            // ignore quote errors; show chart anyway
        }

        const labels = data.data.map(d => d.date);
        const prices = data.data.map(d => d.close);

        if (chart) chart.destroy();
        const colors = getChartColors();
        chart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets: [{ label: symbol.toUpperCase(), data: prices, borderColor: colors.border, backgroundColor: colors.fill, pointRadius: 0, tension: 0.2 }]},
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { maxTicksLimit: 8, color: colors.tick }, grid: { color: colors.grid } }, y: { ticks: { color: colors.tick }, grid: { color: colors.grid } } }, plugins: { legend: { display: false } } }
        });

        if (quote) {
            quoteInfo.textContent = `O ${quote.open.toFixed(2)}  H ${quote.high.toFixed(2)}  L ${quote.low.toFixed(2)}  C ${quote.close.toFixed(2)}  Vol ${quote.volume}`;
        } else {
            quoteInfo.textContent = 'Quote not available for this symbol.';
        }
    }

    loadBtn.addEventListener('click', load);
    await load();

    // Update chart colors when theme changes
    const observer = new MutationObserver(() => {
        if (!chart) return;
        const colors = getChartColors();
        chart.data.datasets[0].borderColor = colors.border;
        chart.data.datasets[0].backgroundColor = colors.fill;
        chart.options.scales.x.ticks.color = colors.tick;
        chart.options.scales.y.ticks.color = colors.tick;
        chart.options.scales.x.grid.color = colors.grid;
        chart.options.scales.y.grid.color = colors.grid;
        chart.update();
    });
    observer.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });
});
</script>
<script src="{{ url_for('static', filename='js/scripts.js') }}"></script>
</body>
</html>


